{% extends 'admin_temp/base.html' %}
{% block content %}

<main id="main" class="main">
    <div class="container mt-5 mb-5">
        <div class="row">
            <div class="col-md-6">
                <h4 style="text-align: end; padding-right: 10px"></h4>
                <input type="hidden" id="admin-id" value="{{ user_id }}">
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body p-4">
                        <b>{{ thread.first_person }}</b>
                        <input class="thread-id-input" type="hidden" value="{{ thread.id }}">
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification container -->
        <div id="notification-container" class="mt-3"></div>
    </div>
</main>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
    const adminId = "{{ user_id }}";  // Replace with the actual admin user ID
    const adminChannel = new WebSocket(`ws://127.0.0.1:8000/ws/chat/${adminId}/`);

    document.addEventListener('DOMContentLoaded', function () {
        loadNotifications();
    });

    adminChannel.onmessage = function (e) {
        let messageData = JSON.parse(e.data);

        // Check if the message is from a user
        if (messageData.senderId) {
            // Create a customized notification element for the user's message
            let notificationElement = document.createElement('div');
            notificationElement.className = 'custom-notification';
            notificationElement.innerHTML = `
                <div class="alert alert-info" role="alert">
                    <strong>New Message</strong> from ${messageData.senderId}: ${messageData.message}
                </div>
            `;

            // Append the notification to the container
            let notificationContainer = document.getElementById('notification-container');
            notificationContainer.appendChild(notificationElement);

            // Save the notification to local storage
            saveNotification(messageData);
        }
    };

    function saveNotification(notificationData) {
        let notifications = getNotificationsFromStorage();
        notifications.push(notificationData);

        // Save the updated notifications to local storage
        localStorage.setItem('notifications', JSON.stringify(notifications));
    }

    function loadNotifications() {
        let notifications = getNotificationsFromStorage();

        // Display the stored notifications
        notifications.forEach(function (notificationData) {
            // Check if the stored message is from a user
            if (notificationData.senderId) {
                let notificationElement = document.createElement('div');
                notificationElement.className = 'custom-notification';
                notificationElement.innerHTML = `
                    <div class="alert alert-info" role="alert">
                        <strong>New Message</strong> from ${notificationData.senderId}: ${notificationData.message}
                    </div>
                `;

                // Append the notification to the container
                let notificationContainer = document.getElementById('notification-container');
                notificationContainer.appendChild(notificationElement);
            }
        });
    }

    function getNotificationsFromStorage() {
        // Retrieve stored notifications from local storage
        let storedNotifications = localStorage.getItem('notifications');

        // Parse the stored notifications or initialize an empty array
        return storedNotifications ? JSON.parse(storedNotifications) : [];
    }
</script>



{% endblock content %}
